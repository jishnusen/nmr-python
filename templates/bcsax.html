<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.6.0/papaparse.js"></script>
<script>window.jQuery || document.write('<script src="{{
  url_for('static', filename='jquery.js') }}">\x3C/script>')</script>
<script type=text/javascript>
  $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
  let fit_params = {};
  let csvdata = "";
</script>

<script>
let text = "";
</script>

<style>
div.element {
    padding-top: 5px;
}
</style>

<form id="data">
    <div><label for="s11">s11 </label>
        <input id="s11" type="text"></label></div>

    <div class="element"><label for="s22">s22 </label>
        <input id="s22" type="text"></label></div>

	<div class="element"><label for="s33">s33 </label>
        <input id="s33" type="text"></label></div>

	<div class="element"><label for="jfreq">jfreq </label>
        <input id="jfreq" type="text"></label></div>

	<div class="element"><label for="t2">t2 </label>
        <input id="t2" type="text"></label></div>

	<div class="element"><label for="hi">hi </label>
        <input id="hi" type="text"></label></div>

	<div class="element"><label for="lo">lo </label>
        <input id="lo" type="text"></label></div>

	<div class="element"><label for="w0">w0 </label>
        <input id="w0" type="text"></label></div>

	<div class="element"><label for="hasdata">use uploaded data </label>
        <input id="hasdata" type="checkbox"></label></div>
</form>


<input type="file" id="input">
<button type="button" onclick="myFunction()">Submit Upload</button>
<div style="padding-top: 15px"><button type="button" onclick="bcsax()">RUN</button>
    <button type="button" style="padding-left:5px" onclick="bcsaxdown()">DOWNLOAD</button></div>

<img id=plot />

<script>
function myFunction() {
    var file = document.getElementById("input").files[0];
    var reader = new FileReader();
    reader.onload = function(e) {
        text = reader.result;
    }
    reader.readAsText(file);
}
</script>

<script>
    function bcsax() {
        $.getJSON($SCRIPT_ROOT + '/_bcsax', {
            s11: $('#s11').val(),
            s22: $('#s22').val(),
            s33: $('#s33').val(),
            jfreq: $('#jfreq').val(),
            t2: $('#t2').val(),
            hi: $('#hi').val(),
            lo: $('#lo').val(),
            w0: $('#w0').val(),
            hasexpdata: $('#hasdata').is(':checked'),
            expdata: text,
            save: false,
        }, function(data) {
            $("#plot").attr('src', data.result);
        });
    }

    function bcsaxdown() {
        $.getJSON($SCRIPT_ROOT + '/_bcsax', {
            s11: $('#s11').val(),
            s22: $('#s22').val(),
            s33: $('#s33').val(),
            jfreq: $('#jfreq').val(),
            t2: $('#t2').val(),
            hi: $('#hi').val(),
            lo: $('#lo').val(),
            hasexpdata: $('#hasdata').is(':checked'),
            expdata: text,
            save: true,
        }, function(data) {
            $("#plot").attr('src', data.result);
            download("data.csv", data.dwnld);
        });
    }

    
    function download(filename, text) {
        var element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);

        element.style.display = 'none';
        document.body.appendChild(element);

        element.click();

        document.body.removeChild(element);
    }

</script>
